<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title><%= title %></title>
  <link href="/css/styles.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js" defer></script>
</head>

<body class="bg-white text-gray-900">

<!-- GLOBAL ALPINE STORE -->
<script>
document.addEventListener('alpine:init', () => {
  Alpine.store('ad', {
    country: "",
    city: "",
    category: null,
    subcategory: null
  });
});
</script>

<div class="max-w-3xl mx-auto py-16 px-6">

  <h1 class="text-4xl font-semibold mb-6 tracking-tight">Post a new ad</h1>
  <p class="text-lg text-gray-600 mb-10">Follow the steps to choose your location and category.</p>

  <!-- STEP 1 -->
  <div id="step1" x-data="locationStep()">
    <h2 class="text-2xl font-medium mb-6">Choose your location</h2>

    <!-- Country -->
    <label class="block mb-2 text-gray-700 font-medium">Country</label>
    <select x-model="selectedCountry" @change="loadCities()"
            class="w-full p-3 border rounded-lg bg-white mb-2 text-black">
      <option value="">Select a country</option>
      <template x-for="c in countries" :key="c.code">
        <option :value="c.code" x-text="c.code.toUpperCase()"></option>
      </template>
    </select>
    <div class="text-sm text-gray-500 mb-6" x-text="debug"></div>

    <!-- City -->
    <label class="block mb-2 text-gray-700 font-medium">City</label>
    <select x-model="selectedCity" :disabled="cities.length === 0"
            class="w-full p-3 border rounded-lg bg-white mb-2 text-black">
      <option value="">Select a city</option>
      <template x-for="city in cities" :key="city.slug">
        <option :value="city.slug" x-text="city.name"></option>
      </template>
    </select>
    <div class="text-sm text-gray-500 mb-6" x-text="debugCities"></div>

    <button @click="saveAndNext"
            class="w-full bg-pink-600 hover:bg-pink-500 text-white py-3 rounded-lg text-lg font-medium transition-all duration-200">
      Continue →
    </button>
  </div>

  <!-- STEP 2 -->
  <div id="step2" x-data="categoryStep()" style="display:none;">
    <h2 class="text-2xl font-medium mb-6">Choose a category</h2>

    <!-- Category -->
    <label class="block mb-2 text-gray-700 font-medium">Category</label>
    <select x-model="selectedCategoryId" @change="loadSubcategories()"
            class="w-full p-3 border rounded-lg bg-white mb-2 text-black">
      <option value="">Select a category</option>
      <template x-for="cat in categories" :key="cat.id">
        <option :value="cat.id" x-text="cat.name"></option>
      </template>
    </select>
    <div class="text-sm text-gray-500 mb-6" x-text="debug"></div>

    <!-- Subcategory -->
    <label class="block mb-2 text-gray-700 font-medium">Subcategory</label>
    <select x-model="selectedSubcategoryId" :disabled="subcategories.length === 0"
            class="w-full p-3 border rounded-lg bg-white mb-2 text-black">
      <option value="">Select a subcategory</option>
      <template x-for="sub in subcategories" :key="sub.id">
        <option :value="sub.id" x-text="sub.name"></option>
      </template>
    </select>
    <div class="text-sm text-gray-500 mb-6" x-text="debugSub"></div>

    <div class="flex justify-between mt-6">
      <button onclick="prevStep()" class="px-6 py-3 bg-gray-200 hover:bg-gray-300 rounded-lg">← Back</button>
      <button @click="saveAndNext"
              class="px-6 py-3 bg-pink-600 hover:bg-pink-500 text-white rounded-lg transition-all duration-200">
        Continue →
      </button>
    </div>
  </div>

  <!-- STEP 3 -->
  <div id="step3" x-data="summaryStep()" style="display:none;">
    <h2 class="text-3xl font-semibold mb-6">Ready to create your ad?</h2>

    <p class="text-gray-600 mb-10 text-lg">
      You’ve selected your location and category. Let’s move on to creating your ad.
    </p>

    <div class="flex justify-center">
      <button 
        @click="goToNewAd"
        class="px-12 py-4 bg-pink-600 hover:bg-pink-500 text-white text-xl font-semibold rounded-full shadow-lg transition-all duration-200 hover:shadow-xl active:scale-95"
      >
        Create My Ad →
      </button>
    </div>
  </div>

</div>

<!-- Alpine Logic -->
<script>
function locationStep() {
  return {
    countries: [],
    cities: [],
    selectedCountry: "",
    selectedCity: "",
    debug: "",
    debugCities: "",

    async init() {
      this.debug = "Loading countries…";
      const res = await fetch('/api/countries');
      this.countries = await res.json();
      this.debug = `Loaded ${this.countries.length} countries`;
    },

    async loadCities() {
      this.debugCities = "Loading cities…";
      const res = await fetch(`/api/cities?country=${this.selectedCountry}`);
      this.cities = await res.json();
      this.debugCities = `Loaded ${this.cities.length} cities`;
    },

    saveAndNext() {
      Alpine.store('ad').country = this.selectedCountry;
      Alpine.store('ad').city = this.selectedCity;
      nextStep();
    }
  }
}

function categoryStep() {
  return {
    categories: [],
    subcategories: [],
    selectedCategoryId: "",
    selectedSubcategoryId: "",
    debug: "",
    debugSub: "",

    get selectedCategory() {
      return this.categories.find(c => c.id == this.selectedCategoryId) || null;
    },

    get selectedSubcategory() {
      return this.subcategories.find(s => s.id == this.selectedSubcategoryId) || null;
    },

    async init() {
      this.debug = "Loading categories…";
      const res = await fetch('/api/categories');
      this.categories = await res.json();
      this.debug = `Loaded ${this.categories.length} categories`;
    },

    async loadSubcategories() {
      this.debugSub = "Loading subcategories…";
      const res = await fetch(`/api/subcategories?category=${this.selectedCategoryId}`);
      this.subcategories = await res.json();
      this.debugSub = `Loaded ${this.subcategories.length} subcategories`;
    },

    saveAndNext() {
      Alpine.store('ad').category = this.selectedCategory;
      Alpine.store('ad').subcategory = this.selectedSubcategory;
      nextStep();
    }
  }
}

function summaryStep() {
  return {
    init() {},

    goToNewAd() {
      const ad = Alpine.store('ad');

      const url = ad.subcategory
        ? `/${ad.country}/${ad.city}/${ad.category.slug}/${ad.subcategory.slug}/ads/new`
        : `/${ad.country}/${ad.city}/${ad.category.slug}/ads/new`;

      window.location.href = url;
    }
  }
}

// Step Navigation
window.nextStep = function () {
  const steps = ["step1", "step2", "step3"];
  const current = steps.findIndex(id => document.getElementById(id).style.display !== "none");
  document.getElementById(steps[current]).style.display = "none";
  document.getElementById(steps[current + 1]).style.display = "block";
};

window.prevStep = function () {
  const steps = ["step1", "step2", "step3"];
  const current = steps.findIndex(id => document.getElementById(id).style.display !== "none");
  document.getElementById(steps[current]).style.display = "none";
  document.getElementById(steps[current - 1]).style.display = "block";
};
</script>

</body>
</html>

